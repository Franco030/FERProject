
# CFER - Fer Language Interpreter

CFER is a bytecode virtual machine and interpreter for the Fer programming language, implemented in C. This project focuses on performance and portability, utilizing a custom stack-based VM, a single-pass compiler, and manual memory management.

## Project Overview

The interpreter works by compiling source code directly into a dense bytecode representation, which is then executed by a virtual machine. This architecture separates the compilation phase (parsing and error checking) from the runtime execution phase.

## Features

* **Data Types**: Support for floating-point numbers, booleans, strings, and nil.
* **Collections**: Built-in support for **Lists** (`[...]`) and **Dictionaries** (`{key: value}`).
* **Arithmetic & Logic**: Complete set of binary and unary operators.
* **Variables**: Global and local variable scope declarations.
* **Control Flow**: Support for `if/else` branching, `while` loops, `for` loops, `break`, and `continue`.
* **Functions**: First-class functions, allowing function declarations, calls, and return values.
* **Native Functions**: A comprehensive standard library implemented in C for performance (IO, Math, Strings, Time).
* **OOP**: Classes, instances, inheritance, methods, and initializers.
* **String Interning**: All strings are interned using a hash table for efficient equality checks.
* **Garbage Collection**: Mark-and-sweep garbage collector for automatic memory management.
* **Debug Tools**: Built-in disassembler to view generated bytecode chunks.

## Architecture

The project is structured into several modular components:

* **Virtual Machine (vm.c/h)**: The core module that executes the bytecode. It maintains the value stack, call frames, and global state.
* **Compiler (compiler.c/h)**: A single-pass Pratt parser that translates source tokens directly into bytecode chunks.
* **Scanner (scanner.c/h)**: Performs lexical analysis, converting source code strings into a stream of tokens.
* **Chunk (chunk.c/h)**: Represents a sequence of bytecode instructions and constants.
* **Memory (memory.c/h)**: Handles dynamic memory allocation, array resizing, and object freeing (Garbage Collection).
* **Table (table.c/h)**: A hash table implementation used for symbol tables, string interning, and dictionaries.
* **Natives (natives.c/h)**: Implementation of the standard library functions.
* **Values & Objects (value.c/h, object.c/h)**: Defines the runtime representation of data (tagged unions for small values, heap allocation for larger objects like strings and functions).

## Prerequisites

* **C Compiler**: GCC, Clang, or MSVC supporting C17 standard.
* **CMake**: Version 3.17 or higher.

## Build Instructions

To build the interpreter, navigate to the project root and run the following commands:

```sh
mkdir build
cd build
cmake ..
make

```

This will generate the `cfer` executable.

## Usage

### Interactive REPL

Running the executable without arguments starts the Read-Eval-Print Loop (REPL). You can type Fer code line-by-line and see the immediate output.

```sh
./cfer
> print "Hello, World!";
Hello, World!
> 1 + 2 * 3
7

```

### File Execution

To execute a script file, pass the path to the file as an argument:

```sh
./cfer path/to/script.fer

```

## Language Syntax Examples

**Variables and Printing:**

```fer
var greetings = "hello!";
var thankyous = "thank you!";
print greetings; 
print thankyous;

```

**Collections (Lists & Maps):**

```fer
var myList = [1, 2, "three"];
push(myList, 4);
print myList[0]; // 1

var myDict = {"name": "Fer", "version": 1.0};
print myDict["name"];

```

**Control Flow:**

```fer
var condition = true;
if (condition) {
    print "yes";
} else {
    print "no";
}

var i = 0;
while (i < 10) {
    print i;
    i = i + 1;
}

```

**Functions:**

```fer
fun add(a, b) {
    return a + b;
}

print add(5, 10);

```

**Classes**

```fer
class Person {
  init(name) {
    this.name = name;
  }

  introduce() {
    print "Hi, I'm " + this.name;
  }
}

class Student < Person {
  init(name, id) {
    super.init(name);
    this.id = id;
  }

  describe() {
    super.introduce();
    print "I am a student with ID: " + str(this.id);
  }
}

var s = Student("Fran", 101);
s.describe();
```

## Standard Library Reference

The Fer language comes with a built-in standard library exposed via native functions.

### String & General Utilities

| Function | Description |
| --- | --- |
| `str(val)` | Converts a value to its string representation. |
| `len(container)` | Returns length of a string, list, or dictionary. |
| `sub(str, start, [len])` | Returns a substring. |
| `upper(str)` | Converts string to uppercase. |
| `lower(str)` | Converts string to lowercase. |
| `index(str, substr)` | Finds index of first occurrence of substr. |
| `split(str, delim)` | Splits string into a list by delimiter. |
| `trim(str)` | Removes leading/trailing whitespace. |
| `chr(code)` | Converts ASCII code to character. |
| `ord(char)` | Converts character to ASCII code. |

### Collections

| Function | Description |
| --- | --- |
| `push(list, item)` | Adds item to end of list. |
| `pop(list)` | Removes and returns last item of list. |
| `insert(list, idx, val)` | Inserts value at specific index. |
| `remove(list, idx)` | Removes item at specific index. |
| `contains(list, val)` | Checks if list contains value. |
| `keys(dict)` | Returns a list of keys in the dictionary. |
| `hasKey(dict, key)` | Checks if dictionary has specific key. |
| `delete(dict, key)` | Removes key-value pair from dictionary. |

### Mathematics

| Function | Description |
| --- | --- |
| `sqrt(n)`, `pow(b, e)` | Square root and power functions. |
| `floor(n)`, `ceil(n)` | Rounding functions. |
| `rand()` | Returns random float between 0.0 and 1.0. |
| `seed(n)` | Seeds the random number generator. |
| `sin`, `cos`, `tan` | Trigonometric functions (radians). |

### Input / Output & System

| Function | Description |
| --- | --- |
| `print` | (Keyword) Prints expression to stdout. |
| `input([prompt])` | Reads a line from stdin. |
| `read(path)` | Reads file content as string. |
| `write(path, content)` | Writes string to file. |
| `clock()` | Returns CPU time since start. |
| `now()` | Returns current Unix timestamp. |
| `typeof(val)` | Returns string describing type of value. |
| `assert(cond, [msg])` | Aborts execution if condition is false. |
| `exit(code)` | Exits program with status code. |

## Internal Development

### Debugging

The project includes a `debug.c` module. By defining `DEBUG_PRINT_CODE` or `DEBUG_TRACE_EXECUTION` in `common.h` (or enabling them if commented out), the VM will print the disassembled bytecode and the state of the stack during execution.

### Memory Management

Memory is managed manually via `reallocate` in `memory.c`. Objects (strings, functions, lists) are allocated on the heap and managed by a **Garbage Collector**. String interning is handled via `table.c` to ensure unique instances of string literals.
